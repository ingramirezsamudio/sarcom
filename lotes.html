<!DOCTYPE html>
<html lang="es">
<head>

	<meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <!--<meta name="viewport" content="width=device-width, initial-scale=1">-->
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0" />
    <meta name="description" content="">
    <meta name="author" content="">
    <link rel="icon" type="image/png" sizes="16x16" href="dist/images/favicon.png">
    <title>Lotes - SARCOM</title>
	<style type="text/css">

	:root {
	  --blue: #009efb;
	  --indigo: #6610f2;
	  --purple: #7460ee;
	  --pink: #e83e8c;
	  --red: #f62d51;
	  --orange: #fb9678;
	  --yellow: #ffbc34;
	  --green: #36bea6;
	  --teal: #20c997;
	  --cyan: #01c0c8;
	  --white: #fff;
	  --gray: #6c757d;
	  --gray-dark: #343a40;
	  --blue: #009efb;
	  --indigo: #6610f2;
	  --purple: #7460ee;
	  --pink: #e83e8c;
	  --red: #f62d51;
	  --orange: #fb9678;
	  --yellow: #ffbc34;
	  --green: #36bea6;
	  --teal: #20c997;
	  --cyan: #01c0c8;
	  --white: #fff;
	  --gray: #6c757d;
	  --secondary: #f8f9fa;
	  --success: #006666;
	  --success_hover: #004040;
	  --info: #00732d;
	  --warning: #d16901;
	  --warning_hover: #a35201;
	  --default: #949494;
	  --default_hover: #7e7e7e;
	  --danger: #c72344;
	  --light: #f8f9fa;
	  --dark: #343a40;
	  --cyan: #01c0c8;
	  --purple: #7460ee;
	  --primary: #102a83;
	  --primary_hover: #00732d;
	  --focus: 0 0 0 2px rgba(84, 38, 147, 0.3);
	  --breakpoint-xs: 0;
	  --breakpoint-sm: 576px;
	  --breakpoint-md: 768px;
	  --breakpoint-lg: 992px;
	  --breakpoint-xl: 1600px;
	  --font-family-sans-serif: 'Rubik', sans-serif;
	  --font-family-monospace: SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace;
	};

	</style>
	<script src="dist/js/jquery/jquery-3.2.1.min.js"></script>
	<!-- Bootstrap popper Core JavaScript -->
	<script src="dist/js/popper/popper.min.js"></script>
    <script src="dist/js/bootstrap/js/bootstrap.min.js"></script>
    <script src="dist/js/perfect-scrollbar.jquery.min.js"></script>
    <!--Wave Effects -->
    <script src="dist/js/waves.js"></script>
    <!--Menu sidebar -->
    <script id="script" src="dist/js/sidebarmenu.js?v=2"></script>
	<script src="dist/js/jquery.easing.min.js"></script>
	<script src="dist/js/jquery-ui/jquery-ui.min.js"></script>
    <!-- Sweet-Alert  -->
	<link href="dist/js/sweetalert/sweetalert.css" rel="stylesheet" type="text/css">
    <script src="dist/js/sweetalert/sweetalert.min.js"></script>
	<!-- TOAST -->
	<link href="dist/js/toast-master/css/jquery.toast.css" rel="stylesheet">
	<script src="dist/js/toast-master/js/jquery.toast.js"></script>
	<!-- Nprogress -->
	<script src="dist/js/nprogress/nprogress.js"></script>
	<link href="dist/js/nprogress/nprogress.css?v=1" rel="stylesheet">
	<!-- Select2 -->
	<link href="dist/js/select2/css/select2.min.css" rel="stylesheet">
	<link href="dist/js/select2/css/select2-bootstrap4.min.css" rel="stylesheet">
	<script src="dist/js/select2/js/select2.full.min.js"></script>
	<script src="dist/js/select2/js/select2-dropdownPosition.js"></script>
	<script src="dist/js/select2/js/i18n/es.js"></script>
	<!-- Custom -->
	<link href="dist/css/style.css?v=2" rel="stylesheet">
	<link href="dist/css/custom.css?v=6" rel="stylesheet">
	<script src="dist/js/custom.js?v=1"></script>

	<link rel="stylesheet" href="dist/js/bootstrap-table/bootstrap-table.css">
	<script src="dist/js/bootstrap-table/bootstrap-table.js"></script>
	<script src="dist/js/bootstrap-table/extensions/export/bootstrap-table-export.js"></script>
	<script src="dist/js/bootstrap-table/extensions/export/tableExport.js"></script>
	<script src="dist/js/bootstrap-table/locale/bootstrap-table-es-CL.min.js"></script>
	<script src="dist/js/bootstrap-table/extensions/mobile/bootstrap-table-mobile.js"></script>
	<script src="dist/js/qrcode.js" type="text/javascript" ></script>
	<script type="text/javascript" src="dist/js/daterangepicker/moment.min.js"></script>


</head>

<body class="skin-default-dark lock-nav fixed-layout">
    <div class="preloader">
        <div class="loader">
            <div class="loader__figure"></div>
            <p class="loader__label">Cargando Ñamandú...</p>
        </div>
    </div>
    <div id="main-wrapper">
    	<!--include topbar -->
    	<header class="topbar">
			<nav class="navbar top-navbar navbar-expand-md navbar-dark">
				<!-- ============================================================== -->
				<!-- Logo -->
				<!-- ============================================================== -->
				<!--<div class="navbar-header">
					<a class="navbar-brand" href="index">
						<b><img src="<?php echo $logo_icono; ?>" alt="homepage" class="dark-logo" /></b>
						<span>
							<img src="<?php echo $logo_texto; ?>" alt="homepage" class="dark-logo" />
							<img src="dist/images/logo-light-text.png" class="light-logo" alt="homepage" />
						</span>
					</a>
				</div>-->
				<!-- ============================================================== -->
				<!-- End Logo -->
				<!-- ============================================================== -->
				<div class="navbar-collapse">
					<!-- ============================================================== -->
					<!-- toggle and nav items -->
					<!-- ============================================================== -->
					<ul class="navbar-nav mr-auto">
						<!-- This is  -->
						<li class="nav-item hidden-sm-up"> <a class="nav-link nav-toggler waves-effect waves-light" href="javascript:void(0)"><i class="fas fa-bars"></i></a></li>
						<!-- ============================================================== -->
						<!-- Search -->
						<!-- ============================================================== -->
						<!--<li class="nav-item search-box"> <a class="nav-link waves-effect waves-dark" href="javascript:void(0)"><i class="fa fa-search"></i></a>
							<form class="app-search">
								<input type="text" class="form-control" placeholder="Search &amp; enter"> <a class="srh-btn"><i class="fa fa-times"></i></a>
							</form>
						</li>-->
						<li class="nav-item">
							<span class="titulo">Lotes</span>
						</li>
					</ul>
					<!-- <?php //echo $menu_central; ?> -->
					<ul class="navbar-nav my-lg-0">
						<!-- ============================================================== -->
						<!-- User profile and search -->
						<!-- ============================================================== -->
						<!--<li class="nav-item dropdown">
							<a class="nav-link dropdown-toggle text-muted waves-effect waves-dark" href="" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><img src="dist/images/users/1.jpg" alt="user" class="img-circle" width="30"></a>
						</li>-->

						<li class="nav-item dropdown">
							<a class="nav-link dropdown-toggle text-muted waves-effect waves-dark" href="" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><img src="dist/images/users/nobody.png" alt="user" class="img-circle" width="30"></a>
							<div class="dropdown-menu dropdown-menu-right user-dd animated flipInY">
								<span class="with-arrow"><span class="bg-primary"></span></span>
								<div class="d-flex no-block align-items-center p-15 bg-primary text-white m-b-10">
									<div class=""><img src="dist/images/users/nobody.png" alt="user" class="img-circle" width="60"></div>
									<div class="m-l-10">
										<h4 class="m-b-0">Usuario</h4>
										<!--<p class=" m-b-0">varun@gmail.com</p>-->
									</div>
								</div>
								<!--<a class="dropdown-item" href="javascript:void(0)"><i class="ti-user m-r-5 m-l-5"></i> My Profile</a>
								<a class="dropdown-item" href="javascript:void(0)"><i class="ti-wallet m-r-5 m-l-5"></i> My Balance</a>
								<a class="dropdown-item" href="javascript:void(0)"><i class="ti-email m-r-5 m-l-5"></i> Inbox</a>
								<div class="dropdown-divider"></div>
								<a class="dropdown-item" href="javascript:void(0)"><i class="ti-settings m-r-5 m-l-5"></i> Account Setting</a>
								<div class="dropdown-divider"></div>-->
								<!-- <a class="dropdown-item" href="<?php echo url();?>/logout"><i class="fa fa-power-off m-r-5 m-l-5"></i> Cerrar Sesión</a> -->
								<!--<div class="dropdown-divider"></div>
								<div class="p-l-30 p-10"><a href="javascript:void(0)" class="btn btn-sm btn-success btn-rounded">View Profile</a></div>-->
								<button class="dropdown-item" href="" onclick="logout()"><i class="fa fa-power-off m-r-5 m-l-5"></i> Cerrar Sesión</button>

							</div>
						</li>
						<!-- ============================================================== -->
						<!-- User profile and search -->
						<!-- ============================================================== -->
					</ul>
				</div>
			</nav>
		</header>

		<aside class="left-sidebar">
			<div class="d-flex no-block nav-text-box align-items-center">
				<span><img src="dist\images\logo-icon.png" alt="aa"></span>
				<a class="nav-lock waves-effect waves-dark ml-auto hidden-md-down" href="javascript:void(0)"><i class="mdi mdi-toggle-switch"></i></a>
				<a class="nav-toggler waves-effect waves-dark ml-auto hidden-sm-up" href="javascript:void(0)"><i class="ti-menu ti-close"></i></a>
			</div>
			<!-- Sidebar scroll-->
			<div class="scroll-sidebar">
				<!-- Sidebar navigation-->
				<nav class="sidebar-nav">
					<ul id="sidebarnav">
					<!-- se carga en el onload con ajax -->
					</ul>
				</nav>
				<!-- End Sidebar navigation -->
			</div>
			<!-- End Sidebar scroll-->
		</aside>

        <div class="page-wrapper">
            <div class="container-fluid">
                <div class="row">
                    <div class="col-12">
						<div id="toolbar">
							<div class="form-inline" role="form">
								<div class="form-group">
									<button type="button" class="btn btn-primary" id="agregar" data-toggle="modal" data-target="#modal_principal">Registrar Lote</button>
								</div>
							</div>
						</div>
						<table id="tabla" data-url="https://frontliner.namandu.com/android/inc/lotes-data.php?q=ver" data-toolbar="#toolbar" data-show-export="true" data-search="true" data-show-refresh="true" data-show-toggle="true" data-show-columns="true" data-search-align="right" data-buttons-align="right" data-toolbar-align="left" data-pagination="true" data-side-pagination="server" data-classes="table table-hover table-condensed" data-striped="true" data-icons="icons" data-show-fullscreen="true"></table>

						<!-- MODA PRINCIPAL -->
						<div class="modal fade" id="modal_principal" tabindex="-1" role="dialog" aria-labelledby="modalLabel" aria-hidden="true">
							<div class="modal-dialog modal-md2 modal-dialog-centered" role="document">
								<div class="modal-content">
									<div class="modal-header">
										<h5 class="modal-title" id="modalLabel"></h5>
										<button type="button" class="close" data-dismiss="modal" aria-label="Close">
											<span aria-hidden="true">&times;</span>
										</button>
									</div>
                                    <!-- Form Registrar pedido -->
									<form class="form" id="formulario" method="post" enctype="multipart/form-data" action="">
										<input type="hidden" name="hidden_id_lote" id="hidden_id_lote">
										<!-- ID REPARTIDOR -->
										<input type="hidden" name="id_repartidor" id="id_repartidor" value="1">
										<div class="modal-body">
											<div class="row">
												<div class="col-md-12 col-sm-12">
													<div class="form-row">
														<div class="form-group col-md-6 col-sm-6">
															<label for="entidad">Entidad</label>
															<div class="input-group">
                                                                <select class="form-control input-sm select2" name="entidad" id="entidades" aria-label="button-entidad"></select>
                                                            </div>
														</div>
														<div class="form-group col-md-6 col-sm-6">
															<label for="encargado">Encargado</label>
															<input class="form-control input-sm" type="text" name="encargado" id="encargado"  required>
															<!-- <div class="input-group">
                                                                <select class="form-control input-sm select2" name="encargado" id="encargado" aria-label="button-encargado"></select>
                                                            </div> -->
														</div>
													</div>
													<div class="form-row">
														<div class="form-group col-md-6 col-sm-6">
															<label for="cantidad">Cantidad</label>
															<input class="form-control input-sm" type="number" name="cantidad" id="cantidad"  required value="50">
														</div>
														<div class="form-group col-md-6 col-sm-6">
															<label for="fecha-entrega">Fecha Tope</label>
															<input class="form-control input-sm" id="fecha_tope" name="fecha_tope" type="date"  required>
														</div>
													</div>
													<div class="form-row">
														<div class="form-group col-md-6 col-sm-6">
															<label for="zona">Zona</label>
															<div class="input-group">
																<select class="form-control input-sm select2" name="zona" id="zonas" aria-label="button-zona"></select>
                                                            </div>
														</div>
													</div>
												</div>
											</div>

										</div>
										<div class="modal-footer">
											<button id="eliminar" type="button" class="btn btn-danger mr-auto" style="display:none">Eliminar</button>
											<button type="button" class="btn btn-secondary" data-dismiss="modal">Cerrar</button>
											<button type="submit" class="btn btn-success">Guardar</button>
										</div>
									</form>
								</div>
							</div>
						</div>

						<!-- MODA PRINCIPAL -->
									<div class="modal fade" id="modal_detalles" tabindex="-1" role="dialog" aria-labelledby="modalLabel" aria-hidden="true">
										<div class="modal-dialog modal-dialog-98  modal-dialog-centered" role="document" >
											<div class="modal-content">
												<div class="modal-header">
													<h5 class="modal-title" id="modalLabel2"></h5>
													<button type="button" class="close" data-dismiss="modal" aria-label="Close">
														<span aria-hidden="true">&times;</span>
													</button>
												</div>
												<form class="form" id="formulario_detalle" method="post" enctype="multipart/form-data" action="">

													<div class="modal-body">
														<div class="row">
															<div class="col-md-12 col-sm-12">
																<div class="form-row">


																</div>
																<div class="form-row">

																	<div class="col-md-12 col-sm-12 col-xs-12">
																		<br> <hr> <br>
																		<table id="tabla_detalle" data-pagination="false" data-classes="table table-hover table-condensed" data-striped="false" name="tabla_detalle[]" ></table>
																	</div>

																</div>
															</div>
														</div>
													</div>
													<div class="modal-footer">
														<!-- <button id="eliminar" type="button" class="btn btn-danger mr-auto" style="display:none">Eliminar</button> -->
														<button type="button" class="btn btn-secondary" data-dismiss="modal">Cerrar</button>
													</div>
												</form>
											</div>
										</div>
									</div>







					</div><!-- End col-12 -->
                </div><!-- End Page Content -->
            </div><!-- End Container fluid  -->
        </div><!-- End Page wrapper  -->
       <!-- <?phpinclude 'footer.php'; ?> -->
    </div><!-- End Wrapper -->
<script type="text/javascript">
$(document).ready( function () {
	//verificar login
	if (localStorage.getItem("id_usuario")) {
		//console.log('esta logueado');
		//location.replace("inicio.html");
	}else {
		console.log('NO esta logueado');
		location.replace("login.html");
	}

	//definir tipo de usuario
	if (localStorage.getItem("tipo_usuario")=='superadmin') {
		tipo_usuario = 'superadmin';
	}else if (localStorage.getItem("tipo_usuario")=='admin') {
		tipo_usuario = 'admin';
	}else if (localStorage.getItem("tipo_usuario")=='proveedor') {
		tipo_usuario = 'proveedor';
	}else if (localStorage.getItem("tipo_usuario")=='cliente') {
		tipo_usuario = 'cliente';
	}else if (localStorage.getItem("tipo_usuario")=='encargado') {
		tipo_usuario = 'encargado';
	}
	else {
		tipo_usuario = 'visitante';
	};

	//ajax para el leftbar
	$.ajax({
		dataType: 'html',
		async: true,
		type: 'POST',
		url: 'https://frontliner.namandu.com/android/inc/leftbar-data.php',
		cache: false,
		data: {q: tipo_usuario},
		success: function (data, status, xhr) {
			var n = data.toLowerCase().indexOf("error");
			if (n == -1) {
				$('#sidebarnav').html(data);
				cargarScriptMenu();
			}else{
				alertDismissJS(data, "error");
			}
		},
		error: function (jqXhr) {
			alertDismissJS($(jqXhr.responseText).text().trim(), "error");
		}
	});
});

function cargarScriptMenu() {
		let scriptActual = document.getElementById('script');
		let nuevoScript = document.createElement('script');
		nuevoScript.src = 'dist/js/sidebarmenu.js?v=2';

		document.head.replaceChild(nuevoScript, scriptActual);
	}

function logout(){
		localStorage.clear();
		sessionStorage.clear();
		location.replace('login.html');
}
	/*$('.modal').on("hidden.bs.modal", function (e) { //fire on closing modal box
		if ($('.modal:visible').length) { // check whether parent modal is opend after child modal close
			$('body').addClass('modal-open'); // if open mean length is 1 then add a bootstrap css class to body of the page
		}
	});*/

	function iconosFila(value, row, index) {
		return [
			'<button type="button" onclick="javascript:void(0)" class="btn btn-info btn-sm editar" title="Editar datos"><i class="fa fa-edit"></i>&nbsp Editar</button>',
			'<button type="button" onclick="javascript:void(0)" class="btn btn-secondary btn-sm ver" title="Ver detalle de los Pedidos"><i class="fa fa-search"></i>&nbsp Detalles</button>',
			'<button type="button" onclick="javascript:void(0)" class="btn btn-primary btn-sm iniciar" title="Iniciar Entrega de Lote"><i class="fa fa-truck"></i>&nbsp Iniciar</button>',
		].join('');
	}

	window.accionesFila = {
		'click .editar': function (e, value, row, index) {
			$('#modalLabel').html('Editar Lote');
			$('#formulario').attr('action', 'editar');
			$('#eliminar').show();
			$('#modal_principal').modal('show');
			$("#hidden_id_lote").val(row.id_lote);
			// $("#entidad").val(row.entidad);
			$("#entidades").select2('trigger', 'select', {
				data: { id: row.id_entidad, text: row.entidad }
			});
			$("#encargado").val(row.encargado);
			$("#cantidad").val(row.cantidad);
			$("#fecha_tope").val(row.fecha_tope);
			$("#zonas").select2('trigger', 'select', {
				data: { id: row.id_zona, text: row.zona }
			});
		},
		'click .ver': function (e, value, row, index) {
			$('#modalLabel2').html('Detalles del Lote Nro: '+row.id_lote);

			$('#modal_detalles').modal('show');
			$("#hidden_id_lote").val(row.id_lote);
			$('#tabla_detalle').bootstrapTable('refresh', {url: 'https://frontliner.namandu.com/android/inc/lotes-data.php?q=ver_detalle&id_lote='+row.id_lote});


		},
		'click .iniciar': function (e, value, row, index) {
			if (row.estado=='EN TRÁNSITO') {
				swal({
					title: "Ya se ha dado inicio a este lote",
					text: "",
					type: "warning",
					showCancelButton: false,
					confirmButtonColor: "var(--secondary)",
					confirmButtonText: "Cerrar",
					cancelButtonText: "Cancelar",
					closeOnConfirm: true
				});
			}else {
				swal({
					title: "¿Desea iniciar la entrega de este lote?",
					text: "El estado cambiará a 'EN TRÁNSITO' y se activará el seguimiento GPS.",
					type: "warning",
					showCancelButton: true,
					confirmButtonColor: "var(--primary)",
					confirmButtonText: "Iniciar",
					cancelButtonText: "Cancelar",
					closeOnConfirm: false
				}, function(){
					$.ajax({
						url: 'https://frontliner.namandu.com/android/inc/lotes-data.php',
						dataType: 'html',
						type: 'post',
						contentType: 'application/x-www-form-urlencoded',
						data: {q: 'iniciar', id_lote: row.id_lote  },
						beforeSend: function(){
							NProgress.start();
						},
						success: function(datos, textStatus, jQxhr){
							NProgress.done();
							var n = datos.toLowerCase().indexOf("error");
							if (n == -1) {
								alertDismissJS(datos, "ok");
								$('#tabla').bootstrapTable('refresh', {url: 'https://frontliner.namandu.com/android/inc/lotes-data.php?q=ver'});
							}else{
								alertDismissJS(datos, "error");
							}
						},
						error: function(jqXhr, textStatus, errorThrown){
							NProgress.done();
							alertDismissJS($(jqXhr.responseText).text().trim(), "error");
						}
					});
					swal.close();
				});

			}

		}
	}

	$('#tabla_detalle').bootstrapTable({
			height: $(window).height()-380,
			sortName: "id_lote",
			showFooter: true,
			sortable:false,

			columns: [
				[
					{	field: 'entidad', align: 'left', valign: 'middle', title: 'Entidad' },
					{	field: 'razon_social', align: 'left', valign: 'middle', title: 'Destinatario', cellStyle: truncarColumna },
					{	field: 'ruc', align: 'left', valign: 'middle', title: 'RUC' },
					{	field: 'direccion', align: 'left', valign: 'middle', title: 'Dirección', cellStyle: truncarColumna },
					{	field: 'consideraciones', align: 'left', valign: 'middle', title: 'Observación/Consideración', cellStyle: truncarColumna },
					{	field: 'nro_casa', align: 'left', valign: 'middle', title: 'Nro. de Casa' },
					{	field: 'zona', align: 'left', valign: 'middle', title: 'Zona' },
					{	field: 'fecha_tope', align: 'left', valign: 'middle', title: 'Fecha Tope' },
					{	field: 'estado', align: 'left', valign: 'middle', title: 'Estado', formatter: colorEstado },
					{	field: 'observaciones', align: 'left', valign: 'middle', title: 'Observaciones', cellStyle: truncarColumna },
					{	field: 'zona', align: 'left', valign: 'middle', title: 'Zona' },
					{	field: 'cantidad_reprogramaciones', align: 'left', valign: 'middle', title: 'Reprogramado' }
				]
			]
		});
		//CSS PARA TRUNCAR COLUMNAS MUY LARGAS
	function truncarColumna(value,row,index, field){
		return {
		classes: 'verTooltip',
		css: {"max-width": "50px" , "white-space": "pre", "overflow": "hidden", "text-overflow": "ellipsis"}
		};
	}
	//TOOLTIP EN COLUMNAS TRUNCADAS
	$('#tabla_detalle').on('mouseenter', ".verTooltip", function () {
			var $this = $(this);
			$this.attr('title', $this.text());
	});

	function colorEstado(data) {
 		switch (data) {
 			case 'PENDIENTE':
                 return '<span style="text-transform: capitalize;" class="badge badge-pill badge-danger"><i class="fas fa-hourglass-half my-1 mx-1"></i> ' + data + '</span></b>';
                break;
             case 'ENTREGADO':
                 return '<span style="text-transform: capitalize;" class="badge badge-pill badge-success"><i class="fas fa-check my-1 mx-1"></i>' + data + '</span></b>';
                 break;
             case 'REPROGRAMADO':
                 return '<span style="text-transform: capitalize;" class="badge badge-pill badge-info"><i class="fas fa-clock my-1 mx-1"></i> ' + data + '</span></b>';
                 break;
             case 'EN TRÁNSITO':
                 return '<span style="text-transform: capitalize;" class="badge badge-pill badge-warning"><i class="fas fa-truck my-1 mx-1"></i> ' + data + '</span></b>';
                break;
 			default:
 				return '<span style="text-transform: capitalize;" class="badge badge-pill badge-default"><i class="fas fa-ban my-1 mx-1"></i> ' + data + '</span></b>';

         }
     }




	//TOOLTIP EN COLUMNAS TRUNCADAS
	$('#tabla').on('mouseenter', ".verTooltip", function () {
		var $this = $(this);
		$this.attr('title', $this.text());
	});

	//CSS PARA TRUNCAR COLUMNAS MUY LARGAS
	function truncarColumna(value,row,index, field){
	  return {
		classes: 'verTooltip',
		css: {"max-width": "150px" , "white-space": "pre", "overflow": "hidden", "text-overflow": "ellipsis"}
	  };
	}

	$("#tabla").bootstrapTable({
		mobileResponsive: true,
		height: $(window).height()-90,
		pageSize: Math.floor(($(window).height()-90)/50),
		sortName: "id_lote",
		sortOrder: 'desc',
		trimOnSearch: false,
		columns: [
			[
				{	field: 'id_lote', align: 'left', valign: 'middle', title: 'Nº Lote', sortable: true, visible: true },
				{	field: 'proveedor', align: 'left', valign: 'middle', title: 'Repartidor', sortable: true, visible: false	},
				{	field: 'id_entidad', align: 'left', valign: 'middle', title: 'ID Entidad', sortable: true, visible: false },
				{	field: 'entidad', align: 'left', valign: 'middle', title: 'Entidad', sortable: true	},
				{	field: 'encargado', align: 'left', valign: 'middle', title: 'Encargado', sortable: true	},
				{	field: 'id_zona', align: 'left', valign: 'middle', title: 'ID Zona', sortable: true, visible: false	},
				{	field: 'zona', align: 'left', valign: 'middle', title: 'Zona', sortable: true	},
				{	field: 'cantidad', align: 'left', valign: 'middle', title: 'Cantidad', sortable: true	},
				{	field: 'fecha_tope', align: 'left', valign: 'middle', title: 'Fecha Tope', sortable: true	},
				{	field: 'fecha_registro', align: 'left', valign: 'middle', title: 'Fecha y Hora de Registro', sortable: true	},
				{	field: 'estado', align: 'left', valign: 'middle', title: 'Estado', sortable: true	, formatter: colorEstado},
				{	field: 'acciones', align: 'center', valign: 'middle', title: 'Acciones', sortable: false, events: accionesFila,  formatter: iconosFila	},

				// {	field: 'acciones2', align: 'center', valign: 'middle', title: 'Generar QR', sortable: false, events: accionesFila2,  formatter: iconosFila2	},
				// {	field: 'acciones3', align: 'center', valign: 'middle', title: 'Reenviar PIN', sortable: false, events: accionesFila3,  formatter: iconosFila3	}
			]
		]
	});

	//Altura de tabla automatica
	$(document).ready(function () {
		$(window).bind('resize', function(e)
			{
			  if (window.RT) clearTimeout(window.RT);
			  window.RT = setTimeout(function()
			  {
				$("#tabla").bootstrapTable('refreshOptions', {
					height: $(window).height()-90,
					pageSize: Math.floor(($(window).height()-90)/50),
				});
			  }, 100);
			});
	});


	$('#agregar').click(function(){
		$('#modalLabel').html('Registrar Pedido');
		$('#formulario').attr('action', 'cargar');



	});

	$('#modal_principal').on('show.bs.modal', function (e) {
		if ($('#formulario').attr('action')=="cargar"){
			limpiarModal(e);
			$('#eliminar').hide();

			//fecha tope predefinida a un mes mas
			var today = moment().add(1, 'month').format('YYYY-MM-DD');
			$('#fecha_tope').val(today);

		}
	});

	$('#modal_principal').on('shown.bs.modal', function (e) {
		// $("form input[type!='hidden']:first").focus();
	});

	$(".modal-dialog").draggable({
		handle: ".modal-header"
	});

	function limpiarModal(){
		$(document).find('form').trigger('reset');
		$("#entidades").select2('trigger', 'select', {
			data: { id: '', text: '' }
		});
		$("#zonas").select2('trigger', 'select', {
			data: { id: '', text: '' }
		});
	}

	//GUARDAR NUEVO REGISTRO O CAMBIOS EDITADOS
	$("#formulario").submit(function(e){
		e.preventDefault();
		var data = $(this).serializeArray();
		//data.push({name: 'detalles', value: JSON.stringify($('#tabla_detalles').bootstrapTable('getData'))});
		$.ajax({
			url: 'https://frontliner.namandu.com/android/inc/lotes-data.php?q='+$(this).attr("action"),
			dataType: 'html',
			type: 'post',
			contentType: 'application/x-www-form-urlencoded',
			data: data,
			beforeSend: function(){
				NProgress.start();
			},
			success: function(datos, textStatus, jQxhr){
				NProgress.done();
				var n = datos.toLowerCase().indexOf("error");
				if (n == -1) {
					$('#modal_principal').modal('hide');
					alertDismissJS(datos, "ok");
					$('#tabla').bootstrapTable('refresh', {url: 'https://frontliner.namandu.com/android/inc/lotes-data.php?q=ver'});
				}else{
					alertDismissJS(datos, "error");
				}
			},
			error: function(jqXhr, textStatus, errorThrown){
				NProgress.done();
				alertDismissJS($(jqXhr.responseText).text().trim(), "error");
			}
		});
	});


	//ELIMINAR
	$('#eliminar').click(function(){
		swal({
			title: "¿Eliminar Lote?",
			text: "",
			type: "warning",
			showCancelButton: true,
			confirmButtonColor: "var(--primary)",
			confirmButtonText: "Eliminar",
			cancelButtonText: "Cancelar",
			closeOnConfirm: false
		}, function(){
			$.ajax({
				dataType: 'html',
				async: false,
				type: 'POST',
				url: 'https://frontliner.namandu.com/android/inc/lotes-data.php',
				cache: false,
				data: {q: 'eliminar', id: $("#hidden_id_lote").val() },
				beforeSend: function(){
					NProgress.start();
				},
				success: function (data, status, xhr) {
					var n = data.toLowerCase().indexOf("error");
					if (n == -1) {
						$('#modal_principal').modal('hide');
						swal.close();
						alertDismissJS(data, "ok");
						NProgress.done();
						$('#tabla').bootstrapTable('refresh', {url: 'https://frontliner.namandu.com/android/inc/lotes-data.php?q=ver'});
					}else{
						alertDismissJS(data, "error");
					}
				},
				error: function (jqXhr) {
					alertDismissJS($(jqXhr.responseText).text().trim(), "error");
				}
			});
		});
	});

	//ENTIDADES
    function entidades() {
        $entidades = $('#entidades').select2({
            dropdownParent: $("#modal_principal"),
            placeholder: 'Buscar Entidad',
            language: "es",
            theme: "bootstrap4",
						width: 'style',
						height: 'style',
            allowClear: true,
            selectOnClose: false,
            dropdownPosition: 'below',
            //minimumInputLength: 2,
            //minimumResultsForSearch: 5,
            ajax: {
                url: 'https://frontliner.namandu.com/android/inc/lotes-data.php',
                dataType: 'json',
                delay: 50,
                data: function(params) {
                    return { q: 'buscar_entidades', term: params.term, page: params.page || 1 }
                },
                processResults: function(data, params) {
                    params.page = params.page || 1;
                    return {
                        results: $.map(data, function(obj) { return { id: obj.id_entidad, text: obj.entidad }; }),
                        pagination: { more: (params.page * 5) <= data[0].total_count }
                    };
                },
                cache: true
            }
        });
    }
    entidades();

	// BUSCAR ENCARGAO
	$('#entidades').change(function() {

		if ($('#entidades').val()) {

			var id_entidad = $('#entidades').val();

			$.ajax({
				dataType: 'json',
				contentType: 'application/x-www-form-urlencoded',
				type: 'GET',
				url: 'https://frontliner.namandu.com/android/inc/lotes-data.php',
				cache: false,
				data: { q: 'buscar_encargado', id_entidad: id_entidad },
				beforeSend: function(){
					// NProgress.start();
				},
				success: function (json, status, xhr) {
					$('#encargado').val(json.encargado);
				},
				error: function (jqXhr) {
					// alertDismissJS($(jqXhr.responseText).text().trim(), "error");
				}
			});

		} else {
			$('#encargado').val("");
		}
	});


	//ZONAS
	function zonas() {
            $zonas = $('#zonas').select2({
                dropdownParent: $("#modal_principal"),
                placeholder: 'Buscar Zonas',
                language: "es",
                theme: "bootstrap4",
                width: 'style',
                allowClear: true,
                selectOnClose: false,
                dropdownPosition: 'below',
                //minimumInputLength: 2,
                //minimumResultsForSearch: 5,
                ajax: {
                    url: 'https://frontliner.namandu.com/android/inc/lotes-data.php',
                    dataType: 'json',
                    delay: 50,
                    data: function(params) {
                        return { q: 'buscar_zonas', term: params.term, page: params.page || 1 }
                    },
                    processResults: function(data, params) {
                        params.page = params.page || 1;
                        return {
                            results: $.map(data, function(obj) { return { id: obj.id_zona, text: obj.zona }; }),
                            pagination: { more: (params.page * 5) <= data[0].total_count }
                        };
                    },
                    cache: true
                }
            });
        }
        zonas();









</script>
</body>
</html>
