<!DOCTYPE html>
<html lang="es">
<head>

	<meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <!--<meta name="viewport" content="width=device-width, initial-scale=1">-->
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0" />
    <meta name="description" content="">
    <meta name="author" content="">
    <link rel="icon" type="image/png" sizes="16x16" href="dist/images/favicon.png">
    <title>Envios en tránsito - SARCOM</title>
	<style type="text/css">

	:root {
	  --blue: #009efb;
	  --indigo: #6610f2;
	  --purple: #7460ee;
	  --pink: #e83e8c;
	  --red: #f62d51;
	  --orange: #fb9678;
	  --yellow: #ffbc34;
	  --green: #36bea6;
	  --teal: #20c997;
	  --cyan: #01c0c8;
	  --white: #fff;
	  --gray: #6c757d;
	  --gray-dark: #343a40;
	  --blue: #009efb;
	  --indigo: #6610f2;
	  --purple: #7460ee;
	  --pink: #e83e8c;
	  --red: #f62d51;
	  --orange: #fb9678;
	  --yellow: #ffbc34;
	  --green: #36bea6;
	  --teal: #20c997;
	  --cyan: #01c0c8;
	  --white: #fff;
	  --gray: #6c757d;
	  --secondary: #f8f9fa;
	  --success: #006666;
	  --success_hover: #004040;
	  --info: #00732d;
	  --warning: #d16901;
	  --warning_hover: #a35201;
	  --default: #949494;
	  --default_hover: #7e7e7e;
	  --danger: #c72344;
	  --light: #f8f9fa;
	  --dark: #343a40;
	  --cyan: #01c0c8;
	  --purple: #7460ee;
	  --primary: #102a83;
	  --primary_hover: #00732d;
	  --focus: 0 0 0 2px rgba(84, 38, 147, 0.3);
	  --breakpoint-xs: 0;
	  --breakpoint-sm: 576px;
	  --breakpoint-md: 768px;
	  --breakpoint-lg: 992px;
	  --breakpoint-xl: 1600px;
	  --font-family-sans-serif: 'Rubik', sans-serif;
	  --font-family-monospace: SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace;
	};

	</style>
	<script src="dist/js/jquery/jquery-3.2.1.min.js"></script>
	<!-- Bootstrap popper Core JavaScript -->
	<script src="dist/js/popper/popper.min.js"></script>
    <script src="dist/js/bootstrap/js/bootstrap.min.js"></script>
    <script src="dist/js/perfect-scrollbar.jquery.min.js"></script>
    <!--Wave Effects -->
    <script src="dist/js/waves.js"></script>
    <!--Menu sidebar -->
    <script src="dist/js/sidebarmenu.js?v=2"></script>
	<script src="dist/js/jquery.easing.min.js"></script>
	<script src="dist/js/jquery-ui/jquery-ui.min.js"></script>
    <!-- Sweet-Alert  -->
	<link href="dist/js/sweetalert/sweetalert.css" rel="stylesheet" type="text/css">
    <script src="dist/js/sweetalert/sweetalert.min.js"></script>
	<!-- TOAST -->
	<link href="dist/js/toast-master/css/jquery.toast.css" rel="stylesheet">
	<script src="dist/js/toast-master/js/jquery.toast.js"></script>
	<!-- Nprogress -->
	<script src="dist/js/nprogress/nprogress.js"></script>
	<link href="dist/js/nprogress/nprogress.css?v=1" rel="stylesheet">
	<!-- Select2 -->
	<link href="dist/js/select2/css/select2.min.css" rel="stylesheet">
	<link href="dist/js/select2/css/select2-bootstrap4.min.css" rel="stylesheet">
	<script src="dist/js/select2/js/select2.full.min.js"></script>
	<script src="dist/js/select2/js/select2-dropdownPosition.js"></script>
	<script src="dist/js/select2/js/i18n/es.js"></script>
	<!-- Custom -->
	<link href="dist/css/style.css?v=2" rel="stylesheet">
	<link href="dist/css/custom.css?v=6" rel="stylesheet">
	<script src="dist/js/custom.js?v=1"></script>

	<link rel="stylesheet" href="dist/js/bootstrap-table/bootstrap-table.css">
	<script src="dist/js/bootstrap-table/bootstrap-table.js"></script>
	<script src="dist/js/bootstrap-table/extensions/export/bootstrap-table-export.js"></script>
	<script src="dist/js/bootstrap-table/extensions/export/tableExport.js"></script>
	<script src="dist/js/bootstrap-table/locale/bootstrap-table-es-CL.min.js"></script>
	<script src="dist/js/bootstrap-table/extensions/mobile/bootstrap-table-mobile.js"></script>
	<script src="dist/js/qrcode.js" type="text/javascript" ></script>
</head>

<body class="skin-default-dark lock-nav fixed-layout">
    <div class="preloader">
        <div class="loader">
            <div class="loader__figure"></div>
            <p class="loader__label">Cargando Ñamandú...</p>
        </div>
    </div>
    <div id="main-wrapper">
    	<!--include topbar -->
    	<header class="topbar">
			<nav class="navbar top-navbar navbar-expand-md navbar-dark">
				<!-- ============================================================== -->
				<!-- Logo -->
				<!-- ============================================================== -->
				<!--<div class="navbar-header">
					<a class="navbar-brand" href="index">
						<b><img src="<?php echo $logo_icono; ?>" alt="homepage" class="dark-logo" /></b>
						<span>
							<img src="<?php echo $logo_texto; ?>" alt="homepage" class="dark-logo" />
							<img src="dist/images/logo-light-text.png" class="light-logo" alt="homepage" />
						</span>
					</a>
				</div>-->
				<!-- ============================================================== -->
				<!-- End Logo -->
				<!-- ============================================================== -->
				<div class="navbar-collapse">
					<!-- ============================================================== -->
					<!-- toggle and nav items -->
					<!-- ============================================================== -->
					<ul class="navbar-nav mr-auto">
						<!-- This is  -->
						<li class="nav-item hidden-sm-up"> <a class="nav-link nav-toggler waves-effect waves-light" href="javascript:void(0)"><i class="fas fa-bars"></i></a></li>
						<!-- ============================================================== -->
						<!-- Search -->
						<!-- ============================================================== -->
						<!--<li class="nav-item search-box"> <a class="nav-link waves-effect waves-dark" href="javascript:void(0)"><i class="fa fa-search"></i></a>
							<form class="app-search">
								<input type="text" class="form-control" placeholder="Search &amp; enter"> <a class="srh-btn"><i class="fa fa-times"></i></a>
							</form>
						</li>-->
						<li class="nav-item">
							<span class="titulo">Envios en tránsito</span>
						</li>
					</ul>
					<!-- <?php //echo $menu_central; ?> -->
					<ul class="navbar-nav my-lg-0">
						<!-- ============================================================== -->
						<!-- User profile and search -->
						<!-- ============================================================== -->
						<!--<li class="nav-item dropdown">
							<a class="nav-link dropdown-toggle text-muted waves-effect waves-dark" href="" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><img src="dist/images/users/1.jpg" alt="user" class="img-circle" width="30"></a>
						</li>-->

						<li class="nav-item dropdown">
							<a class="nav-link dropdown-toggle text-muted waves-effect waves-dark" href="" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><img src="dist/images/users/nobody.png" alt="user" class="img-circle" width="30"></a>
							<div class="dropdown-menu dropdown-menu-right user-dd animated flipInY">
								<span class="with-arrow"><span class="bg-primary"></span></span>
								<div class="d-flex no-block align-items-center p-15 bg-primary text-white m-b-10">
									<div class=""><img src="dist/images/users/nobody.png" alt="user" class="img-circle" width="60"></div>
									<div class="m-l-10">
										<h4 id="nombre_usuario" class="m-b-0">Usuario</h4>
										<!--<p class=" m-b-0">varun@gmail.com</p>-->
									</div>
								</div>
								<!--<a class="dropdown-item" href="javascript:void(0)"><i class="ti-user m-r-5 m-l-5"></i> My Profile</a>
								<a class="dropdown-item" href="javascript:void(0)"><i class="ti-wallet m-r-5 m-l-5"></i> My Balance</a>
								<a class="dropdown-item" href="javascript:void(0)"><i class="ti-email m-r-5 m-l-5"></i> Inbox</a>
								<div class="dropdown-divider"></div>
								<a class="dropdown-item" href="javascript:void(0)"><i class="ti-settings m-r-5 m-l-5"></i> Account Setting</a>
								<div class="dropdown-divider"></div>-->
								<!-- <a class="dropdown-item" href="<?php echo url();?>/logout"><i class="fa fa-power-off m-r-5 m-l-5"></i> Cerrar Sesión</a> -->
								<!--<div class="dropdown-divider"></div>
								<div class="p-l-30 p-10"><a href="javascript:void(0)" class="btn btn-sm btn-success btn-rounded">View Profile</a></div>-->
								<button class="dropdown-item" href="" onclick="logout()"><i class="fa fa-power-off m-r-5 m-l-5"></i> Cerrar Sesión</button>

							</div>
						</li>
						<!-- ============================================================== -->
						<!-- User profile and search -->
						<!-- ============================================================== -->
					</ul>
				</div>
			</nav>
		</header>

		<aside class="left-sidebar">
			<div class="d-flex no-block nav-text-box align-items-center">
				<span><img src="dist\images\logo-icon.png" alt="aa"></span>
				<a class="nav-lock waves-effect waves-dark ml-auto hidden-md-down" href="javascript:void(0)"><i class="mdi mdi-toggle-switch"></i></a>
				<a class="nav-toggler waves-effect waves-dark ml-auto hidden-sm-up" href="javascript:void(0)"><i class="ti-menu ti-close"></i></a>
			</div>
			<!-- Sidebar scroll-->
			<div class="scroll-sidebar">
				<!-- Sidebar navigation-->
				<nav class="sidebar-nav">
					<ul id="sidebarnav">
					<!-- se carga en el onload con ajax -->
					</ul>
				</nav>
				<!-- End Sidebar navigation -->
			</div>
			<!-- End Sidebar scroll-->
		</aside>

        <div class="page-wrapper">
            <div class="container-fluid">
                <div class="row">
                    <div id="content-mapa">
                        <div id="map" style="width: 100%; height: 100%;"></div>
					</div>
					<!-- MODA DATOS DE ENVIO -->
					<div class="modal fade" id="modal_info_envio" tabindex="-1" role="dialog" aria-labelledby="modalLabel" aria-hidden="true" data-backdrop="static" data-keyboard="true">
						<div class="modal-dialog modal-md2 modal-dialog-centered" role="document">
							<div class="modal-content">
								<div class="modal-header">
									<h5 class="modal-title" id="modalLabel">INFORMACIÓN DE ENVIO</h5>
									<button type="button" class="close" data-dismiss="modal" aria-label="Close">
										<span aria-hidden="true">&times;</span>
									</button>
								</div>
								<!-- Form Registrar pedido -->
								<form class="form" id="formulario" method="post" enctype="multipart/form-data" action="">
									<div class="modal-body">
										<div class="row">
											<div class="col-md-12 col-sm-12">
												<div class="form-row">
													<div class="form-group col-md-3 col-sm-6">
														<label for="ruc">CI / RUC</label>
														<input class="form-control input-sm" type="text" name="ruc" id="ruc" autocomplete="off" readonly>
													</div>
													<div class="form-group col-md-9 col-sm-12">
														<label for="razon_social">Nombre y Apellido</label>
														<input class="form-control input-sm" type="text" name="razon_social" id="razon_social" autocomplete="off" readonly>
													</div>
													<div class="form-group col-md-6 col-sm-12">
														<label for="razon_social">Correo Electrónico</label>
														<input class="form-control input-sm" type="email" name="correo" id="correo" autocomplete="off" readonly>
													</div>
													<div class="form-group col-md-6 col-sm-12">
														<label for="celular">Celular</label>
														<!-- <a class="form-control input-sm w-100" href="#" name="celular" id="celular"></a> -->
														<input onclick="whatsapp()" class="form-control input-sm" type="text" name="celular" id="celular" autocomplete="off" readonly>
													</div>
													<div class="form-group col-md-6 col-sm-6">
														<label for="direccion">Dirección</label>
														<input class="form-control input-sm" type="text" name="direccion" id="direccion" autocomplete="off" readonly>
													</div>
													<div class="form-group col-md-6 col-sm-6">
														<label for="zona">Zona</label>
														<input class="form-control input-sm" type="text" name="zona" id="zona" autocomplete="off" readonly>
													</div>
												</div>
												<div class="row">
													<div class="form-group col-md-3 col-sm-6">
														<label for="fecha_tope">Fecha Tope</label>
														<input class="form-control input-sm" type="text" name="nro_lote" id="fecha_tope" autocomplete="off" readonly>
													</div>
													<div class="form-group col-md-2 col-sm-3">
														<label for="nro_lote">Nro Lote</label>
														<input class="form-control input-sm" type="text" name="nro_lote" id="nro_lote" autocomplete="off" readonly>
													</div>
													<div class="form-group col-md-2 col-sm-3">
														<label for="reprogramaciones">Reprog.</label>
														<input class="form-control input-sm" type="text" name="reprogramaciones" id="reprogramaciones" autocomplete="off" readonly>
													</div>
													<div class="form-group col-md-5 col-sm-6">
														<label for="entidad">Entidad</label>
														<input class="form-control input-sm" type="text" name="entidad" id="entidad" autocomplete="off" readonly>
													</div>
													<div class="form-group col-md-12 col-sm-12">
														<label for="observacion">Observación/Consideración</label>
														<input class="form-control input-sm" type="text" name="observacion" id="observacion" autocomplete="off" readonly>
													</div>
											</div>

											<div class="row">
											<div class="form-group col-md-12 col-sm-12">
												<input type="hidden" id="hidden_ubicacion_pedido" value="">
												<input type="hidden" id="hidden_ubicacion_repartidor" value="">
												<button class="btn btn-primary btn-sm w-100" type="button" id="navegar" name="button">Iniciar Navegación</button>
												<!-- <a href="http://maps.google.com/maps?saddr=New+York&daddr=San+Francisco">Route New York / San Francisco</a> -->
											</div>
										</div>
									</div>

									</div>
									<div class="modal-footer">
										<button type="button" class="btn btn-secondary" data-dismiss="modal">Cerrar</button>
									</div>
								</form>
							</div>
						</div>
					</div>
                </div><!-- End Page Content -->
            </div><!-- End Container fluid  -->
        </div><!-- End Page wrapper  -->
    </div><!-- End Wrapper -->
<script type="text/javascript">
$(document).ready( function () {
	//verificar login
	if (localStorage.getItem("id_usuario")) {
		console.log('esta logueado');
		//location.replace("inicio.html");
	}else {
		console.log('NO esta logueado');
		location.replace("login.html");
	}

	//definir tipo de usuario
	if (localStorage.getItem("tipo_usuario")=='superadmin') {
		tipo_usuario = 'superadmin';
	}else if (localStorage.getItem("tipo_usuario")=='admin') {
		tipo_usuario = 'admin';
	}else if (localStorage.getItem("tipo_usuario")=='proveedor') {
		tipo_usuario = 'proveedor';
	}else if (localStorage.getItem("tipo_usuario")=='cliente') {
		tipo_usuario = 'cliente';
	}else if (localStorage.getItem("tipo_usuario")=='encargado') {
		tipo_usuario = 'encargado';
	}
	else {
		tipo_usuario = 'visitante';
	};


	//ajax para el leftbar
	$.ajax({
		dataType: 'html',
		async: true,
		type: 'POST',
		url: 'inc/leftbar-data.php',
		cache: false,
		data: {q: tipo_usuario},
		success: function (data, status, xhr) {
			var n = data.toLowerCase().indexOf("error");
			if (n == -1) {
				$('#sidebarnav').html(data);
			}else{
				alertDismissJS(data, "error");
			}
		},
		error: function (jqXhr) {
			alertDismissJS($(jqXhr.responseText).text().trim(), "error");
		}
	});
	$('#nombre_usuario').html(localStorage.getItem("nombre_usuario"));

});

function logout(){
		localStorage.clear();
		sessionStorage.clear();
		location.replace('login.html');
}

    //Altura de tabla automatica
	$(document).ready(function () {
        // Tamaño del mapa al cargar
        $('#content-mapa').css('height', $(window).height()-80 + "px");
        $('#content-mapa').css('width', "100%");

        // Adapta el mapa al redimensionar
		$(window).bind('resize', function(e) {
            if (window.RT) clearTimeout(window.RT);
            window.RT = setTimeout(function() {
                $('#content-mapa').css('height', $(window).height()-80 + "px");
            }, 100);
		});
	});

	function info_envio(id) {
		$.ajax({
			dataType: 'json',
			async: true,
			type: 'POST',
			url: 'inc/navegador-data.php',
			cache: false,
			data: {q: 'info_envio', id_pedido:id },
			beforeSend: function(){
				NProgress.start();
			},
			success: function (json, status, xhr) {
				if (json.razon_social) {
					NProgress.done();
					$("#razon_social").val(json.razon_social);
					$("#correo").val(json.correo);
					$("#celular").val(json.celular);

					$("#observacion").val(json.observacion);
					$("#ruc").val(json.ruc);
					$("#direccion").val(json.direccion);
					$("#zona").val(json.zona);
					$("#fecha_tope").val(json.fecha_tope);
					$("#entidad").val(json.entidad);
					$("#nro_lote").val(json.nro_lote);
					$("#reprogramaciones").val(json.cantidad_reprogramaciones);

					//para navegacion
					$("#hidden_ubicacion_pedido").val(json.ubicacion_pedido);
					$("#hidden_ubicacion_repartidor").val(json.ubicacion_repartidor);

					$('#modal_info_envio').modal('show');
				}else{
					alertDismissJS("No se encontro información del envio", "error");
				}
			},
			error: function (jqXhr) {
				NProgress.start();
				alertDismissJS($(jqXhr.responseText).text().trim(), "error");
			}
		});
	}

	var map;
	// COORDENADAS GRAN ASUNCION
	var pos = {lat: -25.3198336, lng:-57.5537152}
	var marcadores = [];

    function initMap() {
        map = new google.maps.Map(document.getElementById('map'), {
            center: new google.maps.LatLng(pos),
            zoom: 12
        });

        downloadUrl('inc/navegador-data.php?q=ubicacion_pedidos&id_repartidor='+localStorage.getItem("id_repartidor"), mostrar_pedidos);
	}

	function mostrar_pedidos(repartidores) {
		var infoWindow = new google.maps.InfoWindow;

		Array.prototype.forEach.call(repartidores, function(proveedor) {
			var id = proveedor.id_repartidor;
			var nombre = proveedor.nombre;

			var point = new google.maps.LatLng(
				parseFloat(proveedor.lat),
				parseFloat(proveedor.lng)
			);

			var point2 = new google.maps.LatLng(
				parseFloat(proveedor.lat2),
				parseFloat(proveedor.lng2)
			);

			// VENTANA DE INFORMACION
			var infowincontent = document.createElement('div');

			// TITULO DEL LA VENTANA DE INFORMACION
			var h6 = document.createElement('h6');
			h6.textContent = 'Entregar a: '+nombre
			infowincontent.appendChild(h6);

			// SUBTITULO ENVIOS
			var b = document.createElement('b');
			b.textContent = "Lista de pedidos:";
			infowincontent.appendChild(b);
			infowincontent.appendChild(document.createElement('br'));

			// ENVIOS
			Array.prototype.forEach.call(proveedor.pedidos, function(pedido) {
				var a = document.createElement('a');
				a.href = "#" + pedido.id_pedido;
				a.textContent = "-" + pedido.razon_social;

				a.addEventListener('click', function(e) {
					e.preventDefault();
					info_envio(this.href.split("#")[1]);
				});

				infowincontent.appendChild(a);
				infowincontent.appendChild(document.createElement('br'));
			});

			var marker = new google.maps.Marker({
				icon: "dist/images/icon-maps.png",
				map: map,
				position: point,
			});

			var marker2 = new google.maps.Marker({
				icon: "dist/images/icon-maps2.png",
				map: map,
				position: point2,
			});

			marcadores.push(marker);
			marcadores.push(marker2);

			marker.addListener('click', function() {
				infoWindow.setContent(infowincontent);
				infoWindow.open(map, marker);
			});
		});
	}

    function downloadUrl(url, callback) {
        $.ajax({
            dataType: 'json',
            async: true,
            type: 'GET',
            url: url,
            cache: false,
            beforeSend: function(){
				// NProgress.start();
			},
            success: function (data, status, xhr) {
							console.log("Mapa actualizado");
                // NProgress.done();
                if (data[0].id_repartidor || data[0].nombre) {
                	callback(data);
                }else{
                    alertDismissJS("Ningun repartior posee un envio en tránsito", "error");
                }
            },
            error: function (jqXhr) {
                // NProgress.done();
                alertDismissJS($(jqXhr.responseText).text().trim(), "error");
            }
        });
    }

	//ACTUALIZA EL MAPA CADA 30 SEGUNDOS
	setInterval(function() {
		// Elimina los marcadores del mapa
		for (var i = 0; i < marcadores.length; i++) {
			marcadores[i].setMap(null);
		}
		marcadores = [];

		// Carga el mapa con nuevos marcadores
		downloadUrl('inc/navegador-data.php?q=ubicacion_pedidos&id_repartidor='+localStorage.getItem("id_repartidor"), mostrar_pedidos);
	}, 30000);



//iniciar navegacion
//<a href="http://maps.google.com/maps?saddr=New+York&daddr=San+Francisco">Route New York --> San Francisco</a>
$('#navegar').click(function(){
	var ubi_ini = $('#hidden_ubicacion_repartidor').val();
	var ubi_fin =$('#hidden_ubicacion_pedido').val();
	var ubi_url = "http://maps.google.com/maps?saddr="+ubi_ini+"&daddr="+ubi_fin;
	window.location.href = ubi_url;
});
//finalizar navegacion


// UBICACION DEL REPARTIDOR
function geo_success(position) {
	// coordenadas de la ubicacion
	var ubicacion = position.coords.latitude + ',' + position.coords.longitude;

	$.ajax({
		dataType: 'html',
		async: true,
		type: 'POST',
		url: 'inc/repartidores-data.php',
		cache: false,
		// id_repartidor se debe obtener del proveedor logueado
		data: {q: 'guardar_ubicacion',ubicacion: ubicacion , id_repartidor: localStorage.getItem("id_repartidor") },
		success: function (data, status, xhr) {
			var n = data.toLowerCase().indexOf("error");
			if (n == -1) {
				// console.log("ubicacion enviada al servidor : " + ubicacion);
			}else{
				alertDismissJS(data, "error");
			}
		},
		error: function (jqXhr) {
			alertDismissJS($(jqXhr.responseText).text().trim(), "error");
		}
	});
}

function geo_error(error) {
	switch(error.code) {
		case error.PERMISSION_DENIED:
			alertDismissJS("Solicitud de geolocalización denegada, no se podra rastrear su ubicación", "error");
		break;

		case error.POSITION_UNAVAILABLE:
			alertDismissJS("La información de ubicación no está disponible", "error");
		break;

		case error.TIMEOUT:
			alertDismissJS("Tiempo de espera agotado. No se pudo obtener su ubicacion", "error");
		break;

		case error.UNKNOWN_ERROR:
			alertDismissJS("Error no identificado", "error");
		break;
	}
}

if (navigator.geolocation) {
	// se ejecuta cada vez que la ubicacion del proveedor cambie
	if (localStorage.getItem("tipo_usuario")=='proveedor'){
		var wpid = navigator.geolocation.watchPosition(geo_success, geo_error);
	}
} else {
	alertDismissJS("La geolocalización no es compatible con este navegador", "error");
}

// FIN UBICACION DEL REPARTIDOR
function whatsapp(){
	var numero = $('#celular').val();
	console.log(numero);
	location.replace('whatsapp://'+numero);
};


</script>
<script async defer
  src="https://maps.googleapis.com/maps/api/js?key=AIzaSyD1NW86t_rj3bXEDBYplwbqE4ufPJohf34&callback=initMap">
</script>
</body>
</html>
