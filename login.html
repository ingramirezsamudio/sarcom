<!DOCTYPE html>
<html lang="es">
<head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">
    <link rel="icon" type="image/png" sizes="16x16" href="dist/images/favicon.png">
    <title>Sarcom</title>
    <style type="text/css"></style>
    <script src="dist/js/jquery/jquery-3.2.1.min.js"></script>
    <!-- Bootstrap popper Core JavaScript -->
    <script src="dist/js/popper/popper.min.js"></script>
    <script src="dist/js/bootstrap/js/bootstrap.min.js"></script>
    <script src="dist/js/perfect-scrollbar.jquery.min.js"></script>
    <!--Wave Effects -->
    <script src="dist/js/waves.js"></script>
    <!--Menu sidebar -->
    <!-- Sweet-Alert  -->
    <link href="dist/js/sweetalert/sweetalert.css" rel="stylesheet" type="text/css">
    <script src="dist/js/sweetalert/sweetalert.min.js"></script>
    <!-- TOAST -->
    <link href="dist/js/toast-master/css/jquery.toast.css" rel="stylesheet">
    <script src="dist/js/toast-master/js/jquery.toast.js"></script>
    <!-- Nprogress -->
    <script src="dist/js/nprogress/nprogress.js"></script>
    <link href="dist/js/nprogress/nprogress.css?v=1" rel="stylesheet">
    <!-- Custom -->
    <link href="dist/css/style.css?v=2" rel="stylesheet">
    <link href="dist/css/custom.css?v=6" rel="stylesheet">
    <script src="dist/js/custom.js?v=1"></script>
    <link href="dist/css/login.css" rel="stylesheet">

    	<meta http-equiv="content-type" content="text/html; charset=UTF-8">
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <!--<meta name="viewport" content="width=device-width, initial-scale=1">-->
    	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0" />
        <meta name="description" content="">
        <meta name="author" content="">
        <link rel="icon" type="image/png" sizes="16x16" href="dist/images/favicon.png">
        <title>Login - Sarcom</title>
    	<style type="text/css">

    	:root {
    	  --blue: #009efb;
    	  --indigo: #6610f2;
    	  --purple: #7460ee;
    	  --pink: #e83e8c;
    	  --red: #f62d51;
    	  --orange: #fb9678;
    	  --yellow: #ffbc34;
    	  --green: #36bea6;
    	  --teal: #20c997;
    	  --cyan: #01c0c8;
    	  --white: #fff;
    	  --gray: #6c757d;
    	  --gray-dark: #343a40;
    	  --blue: #009efb;
    	  --indigo: #6610f2;
    	  --purple: #7460ee;
    	  --pink: #e83e8c;
    	  --red: #f62d51;
    	  --orange: #fb9678;
    	  --yellow: #ffbc34;
    	  --green: #36bea6;
    	  --teal: #20c997;
    	  --cyan: #01c0c8;
    	  --white: #fff;
    	  --gray: #6c757d;
    	  --secondary: #f8f9fa;
    	  --success: #006666;
    	  --success_hover: #004040;
    	  --info: #00732d;
    	  --warning: #d16901;
    	  --warning_hover: #a35201;
    	  --default: #949494;
    	  --default_hover: #7e7e7e;
    	  --danger: #c72344;
    	  --light: #f8f9fa;
    	  --dark: #343a40;
    	  --cyan: #01c0c8;
    	  --purple: #7460ee;
    	  --primary: #102a83;
    	  --primary_hover: #00732d;
    	  --focus: 0 0 0 2px rgba(84, 38, 147, 0.3);
    	  --breakpoint-xs: 0;
    	  --breakpoint-sm: 576px;
    	  --breakpoint-md: 768px;
    	  --breakpoint-lg: 992px;
    	  --breakpoint-xl: 1600px;
    	  --font-family-sans-serif: 'Rubik', sans-serif;
    	  --font-family-monospace: SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace;
    	};

    	</style>
    	<script src="dist/js/jquery/jquery-3.2.1.min.js"></script>
    	<!-- Bootstrap popper Core JavaScript -->
    	<script src="dist/js/popper/popper.min.js"></script>
        <script src="dist/js/bootstrap/js/bootstrap.min.js"></script>
        <script src="dist/js/perfect-scrollbar.jquery.min.js"></script>
        <!--Wave Effects -->
        <script src="dist/js/waves.js"></script>
        <!--Menu sidebar -->
        <script src="dist/js/sidebarmenu.js?v=2"></script>
    	<script src="dist/js/jquery.easing.min.js"></script>
    	<script src="dist/js/jquery-ui/jquery-ui.min.js"></script>
        <!-- Sweet-Alert  -->
    	<link href="dist/js/sweetalert/sweetalert.css" rel="stylesheet" type="text/css">
        <script src="dist/js/sweetalert/sweetalert.min.js"></script>
    	<!-- TOAST -->
    	<link href="dist/js/toast-master/css/jquery.toast.css" rel="stylesheet">
    	<script src="dist/js/toast-master/js/jquery.toast.js"></script>
    	<!-- Nprogress -->
    	<script src="dist/js/nprogress/nprogress.js"></script>
    	<link href="dist/js/nprogress/nprogress.css?v=1" rel="stylesheet">
    	<!-- Select2 -->
    	<link href="dist/js/select2/css/select2.min.css" rel="stylesheet">
    	<link href="dist/js/select2/css/select2-bootstrap4.min.css" rel="stylesheet">
    	<script src="dist/js/select2/js/select2.full.min.js"></script>
    	<script src="dist/js/select2/js/select2-dropdownPosition.js"></script>
    	<script src="dist/js/select2/js/i18n/es.js"></script>
    	<!-- Custom -->
    	<link href="dist/css/style.css?v=2" rel="stylesheet">
    	<link href="dist/css/custom.css?v=6" rel="stylesheet">
    	<script src="dist/js/custom.js?v=1"></script>

    	<link rel="stylesheet" href="dist/js/bootstrap-table/bootstrap-table.css">
    	<script src="dist/js/bootstrap-table/bootstrap-table.js"></script>
    	<script src="dist/js/bootstrap-table/extensions/export/bootstrap-table-export.js"></script>
    	<script src="dist/js/bootstrap-table/extensions/export/tableExport.js"></script>
    	<script src="dist/js/bootstrap-table/locale/bootstrap-table-es-CL.min.js"></script>
    	<script src="dist/js/bootstrap-table/extensions/mobile/bootstrap-table-mobile.js"></script>
    	<script src="dist/js/qrcode.js" type="text/javascript" ></script>
    </head>
</head>
<div id="div_login" class="login" style="overflow-y: auto; background-image:url(dist/images/background/login-register.jpg);visibility:hidden">
    <div class="form-wrapper-outer">
        <div  id="contenLogin" class="animated pulse">
            <div class="form-logo">
                <img src="dist/images/logo.png" alt="logo">
            </div>
            <div class="form-greeting mb-4">
                <span>SOUTH AMERICAN RIVER COMPANY</span>
            </div>
            <form id="formLogin" method="POST">
              <div class="" id="vieja_contrasena">

                <div class="field-wrapper">
                  <label for="email_login">Usuario</label>
                    <input type="text" name="email_login" id="email_login" value="" autocomplete="off" onkeypress="return event.keyCode!=13">
                    <div class=""></div>
                </div>
                <div class='field-wrapper'>
                  <label for="pass_login">Contraseña</label>

                    <input type='password' name='pass_login' id='pass_login' onkeypress="return event.keyCode!=13">
                    <div class='contra'></div>
                    <small><a id="reiniciar_contrasena" href="#">¿Has olvidado la contraseña?</a></small>
                </div>
              </div>

                <div class="" id="nueva_contrasena">
                  <div class='field-wrapper'>
                    <label for="nuevo_pass">Nueva contraseña</label>
                      <input type='password' name='nuevo_pass' id='nuevo_pass' onkeypress="return event.keyCode!=13">
                  </div>
                  <div class='field-wrapper'>
                    <label for="nuevo_pass_repetir">Repetir nueva contraseña</label>
                      <input type='password' name='nuevo_pass_repetir' id='nuevo_pass_repetir' onkeypress="return event.keyCode!=13">
                  </div>
                </div>




                <div id="codigo" class='field-wrapper mt-4'>
                </div>




                <div class="custom-control custom-checkbox mr-sm-2">
                    <input type="checkbox" class="custom-control-input" id="checkRememberme">
                    <!-- <label class="custom-control-label" for="checkRememberme">Recordar contraseña</label> -->
                </div>
                <br>
                <!-- Show the user profile details -->
                <div class="userContent" style="display: none;"></div>
                <div class="form-button text-center">
                  <button type="submit" class="btn btn-primary" id="login" class="">Iniciar Sesión</button>
                  <button type="button" class="btn btn-primary" id="login_verificar" class="">Actualizar Contraseña</button>
                </div>
                <br>
            </form>
        </div>
    </div>
</div>





<div class="modal fade" id="modal_principal" tabindex="-1" role="dialog" aria-labelledby="modalLabel" aria-hidden="true">
  <div class="modal-dialog modal-md2 modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalLabel2">Reinicio de Contraseña</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <form class="form" id="formulario" method="post" name="formulario" action="">
        <div class="modal-body">
          <div class="row">
            <div class="col-md-12 col-sm-12">
              <div class="form-row">
                <div class="form-group col-md-12 col-sm-12">
                  <label for="email_recuperar">Correo Electrónico</label>
                  <input class="form-control input-sm" type="email" name="email_recuperar" id="email_recuperar"  onkeypress="return event.keyCode!=13" required>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button id="eliminar" type="button" class="btn btn-danger mr-auto" style="display:none">Eliminar</button>
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Cerrar</button>
          <button id="reiniciar_contrasena_boton" type="submit" class="btn btn-primary">Reiniciar</button>
        </div>
      </form>
    </div>
  </div>
</div>


<script>
localStorage.clear();
sessionStorage.clear();
$(document).ready( function () {

  $('#nueva_contrasena').hide();
  $('#login_verificar').hide();
  var estado = GETvalue('estado');
  if (estado=='vencido') {
    alertDismissJS('El link de reseteo ha expirado, debe generar uno nuevo', "error");

    console.log('vencido');

  }else if (estado=='exito') {
    alertDismissJS('La contraseña ha sido reseteada con éxito', "ok");
    console.log('exito');
  }

  $("#formLogin").keypress(function(e) {
      if (e.which == 13) {
          return false;
      }
  });
});

if (!localStorage.id_usuario && !sessionStorage.id_usuario) {
  //console.log('entro');
    $('#div_login').css("visibility", "visible");
    $(function() {
        $(".field-wrapper .field-placeholder").on("click", function() {
            $(this).closest(".field-wrapper").find("input").focus();
        });
        $(".field-wrapper .contra").on("click", function() {
            $(this).closest(".field-wrapper").find("input").focus();
        });
        $(".field-wrapper input").on("keyup", function() {
            var value = $.trim($(this).val());
            if (value) {
                $(this).closest(".field-wrapper").addClass("hasValue");
            } else {
                $(this).closest(".field-wrapper").removeClass("hasValue");
            }
        });
        setTimeout(function() {
            if ($(".field-wrapper input").val()) {
                $(".field-wrapper input").closest(".field-wrapper").addClass("hasValue");
            }
            $('#email_login').focus();
        }, 50);
    });
    $("#formLogin").submit(function(e) {
        e.preventDefault();
        var data = $(this).serializeArray();
		      data.push({name: 'q', value: 'login'});
        $.ajax({
            url: 'inc/login-data.php',
            dataType: 'json',
            type: 'POST',
            contentType: 'application/x-www-form-urlencoded',
            data: data,
            async: false,
            beforeSend: function() {
                NProgress.start();
            },
            success: function(data) {
                NProgress.done();
                if (data.mensaje) {
                    alertDismissJS(data.mensaje, "error");
                } else {

                  if (data[0].verificado=='no') {
                    //si NO esta verificado
                    console.log('NO esta verificado');
                    $('#vieja_contrasena').hide();
                    $('#login').hide();
                    $('#login_verificar').show();
                    $('#nueva_contrasena').show();
                    id_usuariox= data[0].id_usuario;

                  //si NO esta verificado
                }else if (data[0].verificado=='si') {
                    //si esta verificado
                    console.log('esta verificado');
                    localStorage.setItem('id_usuario', data[0].id_usuario);
                    localStorage.setItem('usuario', data[0].usuario);
                    localStorage.setItem('nombre_usuario', data[0].nombre_usuario);
                    localStorage.setItem('tipo_usuario', data[0].tipo_usuario);
                    localStorage.setItem('id_proveedor', data[0].id_proveedor);
                    localStorage.setItem('id_cliente', data[0].id_cliente);
                    localStorage.setItem('id_portero', data[0].id_portero);
                    localStorage.setItem('portero_puerto', data[0].portero_puerto);
                    localStorage.setItem('puerto', data[0].puerto);
                    location.replace('inicio.html');
                    //si esta verificado
                  }
                }

            },
            error: function(data) {
                NProgress.done();
                alertDismissJS(data.mensaje, "error");
            }
        });
    });
} else {
    if (localStorage.tipo_usuario == 1) {
        sessionStorage.id_usuario = localStorage.id_usuario;
    }
	// $.post("https://lebombo.namandu.com/inc/login-data.php", { q: "init", id_usuario: sessionStorage.id_usuario },
	// 	function(data){
	// 	data == "index.html" ? cerrarSesion() : location.assign(data);
	// });
}


$('#login_verificar').click(function(){
  var data2 = $("#formLogin").serializeArray();
  data2.push({name: 'q', value: 'verificar_login'});
  data2.push({name: 'id_usuario', value: id_usuariox});
  $.ajax({
      url: 'inc/login-data.php',
      dataType: 'json',
      type: 'POST',
      contentType: 'application/x-www-form-urlencoded',
      data: data2,
      async: false,
      beforeSend: function() {
          NProgress.start();
      },
      success: function(data) {
          NProgress.done();
          if (data.mensaje=='Contraseña actualizada correctamente') {
            alertDismissJS(data.mensaje, "ok");
            setTimeout(function() {
              location.replace('login.html');
            }, 2000);
          } else {
            alertDismissJS(data.mensaje, "error");
          }
      },
      error: function(data) {
          NProgress.done();
          alertDismissJS(data.mensaje, "error");
      }
  });
});






$('#reiniciar_contrasena').click(function(){
  $('#modal_principal').modal('show');
});


$("#formulario").submit(function(e) {
    e.preventDefault();
    var data = $(this).serializeArray();
      data.push({name: 'q', value: 'reiniciar_contrasena'});
    $.ajax({
        url: 'inc/login-data.php',
        dataType: 'json',
        type: 'POST',
        contentType: 'application/x-www-form-urlencoded',
        data: data,
        async: false,
        beforeSend: function() {
            NProgress.start();
        },
        success: function(data) {
            NProgress.done();
            if (data.mensaje=='El correo electrónico no existe') {
              alertDismissJS(data.mensaje, "error");
            }else if (data.mensaje=='Se ha enviado un email de recuperación a la dirección de Correo Electrónico') {
              alertDismissJS(data.mensaje, "ok");
              $('#modal_principal').modal('hide');
            }else if (data.mensaje=='Error en el envio del email de recuperacion') {
              alertDismissJS(data.mensaje, "error");

            }
        },
        error: function(jqXHR) {
            NProgress.done();
            alertDismissJS('Ha ocurrido un error de base de datos', "error");
        }
    });
});

$('#nuevo_pass_repetir').keypress(function(e) {
       if(e.which == 13) {
         $('#login_verificar').click();
       }
  });

  function GETvalue(q,s) {
    s = (s) ? s : window.location.search;
    var re = new RegExp('&amp;'+q+'=([^&amp;]*)','i');
    return (s=s.replace(/^\?/,'&amp;').match(re)) ?s=s[1] :s='';
}



</script>
</body>
</html>
